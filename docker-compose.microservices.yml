# docker-compose.microservices.yml
# ============================================================
# BrokerX - Architecture Microservices
# ============================================================
#
# Usage:
#   docker compose -f docker-compose.microservices.yml up -d
#   docker compose -f docker-compose.microservices.yml logs -f
#   docker compose -f docker-compose.microservices.yml down -v
#
# Ports:
#   - 8080:  Kong API Gateway
#   - 3001:  Clients Service
#   - 3002:  Portfolios Service
#   - 3003:  Orders Service
#   - 5433:  PostgreSQL (Clients)
#   - 5434:  PostgreSQL (Portfolios)
#   - 5435:  PostgreSQL (Orders)
#   - 6379:  Redis
#   - 8025:  MailHog UI
#   - 9090:  Prometheus (profile: observability)
#   - 3004:  Grafana (profile: observability)

services:
  # ===========================================
  # DATABASES (One per microservice)
  # ===========================================
  
  postgres-clients:
    image: postgres:15-alpine
    container_name: brokerx-postgres-clients
    environment:
      POSTGRES_DB: clients_service_development
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    volumes:
      - postgres_clients_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-portfolios:
    image: postgres:15-alpine
    container_name: brokerx-postgres-portfolios
    environment:
      POSTGRES_DB: portfolios_service_development
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"
    volumes:
      - postgres_portfolios_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-orders:
    image: postgres:15-alpine
    container_name: brokerx-postgres-orders
    environment:
      POSTGRES_DB: orders_service_development
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5435:5432"
    volumes:
      - postgres_orders_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # SHARED INFRASTRUCTURE
  # ===========================================

  redis:
    image: redis:7-alpine
    container_name: brokerx-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mailhog:
    image: mailhog/mailhog:latest
    container_name: brokerx-mailhog
    ports:
      - "1025:1025"
      - "8025:8025"

  # ===========================================
  # MICROSERVICES
  # ===========================================

  clients-service:
    build:
      context: ./services/clients-service
      dockerfile: Dockerfile
    container_name: brokerx-clients-service
    ports:
      - "3001:3000"
    environment:
      RAILS_ENV: development
      DATABASE_HOST: postgres-clients
      DATABASE_PORT: 5432
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      REDIS_URL: redis://redis:6379/0
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      APP_URL: http://localhost:3001
      JWT_SECRET_KEY: microservices_jwt_secret_change_in_production
      SECRET_KEY_BASE: microservices_secret_base_change_in_production
      INSTANCE_ID: clients-1
      RAILS_LOG_TO_STDOUT: "true"
    depends_on:
      postgres-clients:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      bash -c "
        bundle exec rails db:create db:migrate &&
        bundle exec rails db:seed || true &&
        bundle exec rails server -b 0.0.0.0 -p 3000
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  portfolios-service:
    build:
      context: ./services/portfolios-service
      dockerfile: Dockerfile
    container_name: brokerx-portfolios-service
    ports:
      - "3002:3000"
    environment:
      RAILS_ENV: development
      DATABASE_HOST: postgres-portfolios
      DATABASE_PORT: 5432
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      REDIS_URL: redis://redis:6379/1
      CLIENTS_SERVICE_URL: http://clients-service:3000
      JWT_SECRET_KEY: microservices_jwt_secret_change_in_production
      SECRET_KEY_BASE: microservices_secret_base_change_in_production
      INSTANCE_ID: portfolios-1
      RAILS_LOG_TO_STDOUT: "true"
    depends_on:
      postgres-portfolios:
        condition: service_healthy
      redis:
        condition: service_healthy
      clients-service:
        condition: service_healthy
    command: >
      bash -c "
        bundle exec rails db:create db:migrate &&
        bundle exec rails db:seed || true &&
        bundle exec rails server -b 0.0.0.0 -p 3000
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  orders-service:
    build:
      context: ./services/orders-service
      dockerfile: Dockerfile
    container_name: brokerx-orders-service
    ports:
      - "3003:3000"
    environment:
      RAILS_ENV: development
      DATABASE_HOST: postgres-orders
      DATABASE_PORT: 5432
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      REDIS_URL: redis://redis:6379/2
      CLIENTS_SERVICE_URL: http://clients-service:3000
      PORTFOLIOS_SERVICE_URL: http://portfolios-service:3000
      JWT_SECRET: microservices_jwt_secret_change_in_production
      SECRET_KEY_BASE: microservices_secret_base_change_in_production
      ACTION_CABLE_URL: ws://localhost:3003/cable
      INSTANCE_ID: orders-1
      RAILS_LOG_TO_STDOUT: "true"
    depends_on:
      postgres-orders:
        condition: service_healthy
      redis:
        condition: service_healthy
      clients-service:
        condition: service_healthy
    command: >
      bash -c "
        bundle exec rails db:create db:migrate &&
        bundle exec rails db:seed || true &&
        bundle exec rails server -b 0.0.0.0 -p 3000
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # API GATEWAY
  # ===========================================

  kong:
    image: kong:3.4
    container_name: brokerx-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    volumes:
      - ./services/gateway/kong.yml:/kong/kong.yml:ro
    ports:
      - "8080:8000"
      - "8443:8443"
      - "8001:8001"
    depends_on:
      clients-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # OBSERVABILITY (optional)
  # ===========================================

  prometheus:
    image: prom/prometheus:latest
    container_name: brokerx-prometheus-ms
    ports:
      - "9090:9090"
    volumes:
      - ./config/observability/prometheus-microservices.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    restart: unless-stopped
    profiles:
      - observability

  grafana:
    image: grafana/grafana:latest
    container_name: brokerx-grafana-ms
    ports:
      - "3004:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    restart: unless-stopped
    profiles:
      - observability

volumes:
  postgres_clients_data:
  postgres_portfolios_data:
  postgres_orders_data:
