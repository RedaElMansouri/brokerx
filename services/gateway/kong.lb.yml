# Kong Gateway Configuration - BrokerX Microservices with Load Balancing
# ============================================================
# Routes traffic through Nginx Load Balancer
# ============================================================

_format_version: "3.0"
_transform: true

services:
  # ============================================================
  # SWAGGER UI (via Nginx LB â†’ Clients)
  # ============================================================
  - name: swagger
    url: http://nginx-lb:3001
    routes:
      - name: swagger-ui
        paths:
          - /swagger
          - /swagger.html
        methods:
          - GET
        strip_path: false
      
      - name: openapi-spec
        paths:
          - /openapi.yaml
        methods:
          - GET
        strip_path: false

  # ============================================================
  # CLIENTS SERVICE (via Nginx LB)
  # ============================================================
  - name: clients-service
    url: http://nginx-lb:3001
    routes:
      - name: clients-register
        paths:
          - /api/v1/clients
        methods:
          - POST
          - GET
        strip_path: false
      
      - name: clients-verify
        paths:
          - /api/v1/clients/verify
        methods:
          - GET
        strip_path: false
      
      - name: auth-login
        paths:
          - /api/v1/auth/login
        methods:
          - POST
        strip_path: false
      
      - name: auth-mfa
        paths:
          - /api/v1/auth/verify_mfa
        methods:
          - POST
        strip_path: false
      
      - name: me-endpoint
        paths:
          - /api/v1/me
        methods:
          - GET
        strip_path: false
      
      - name: clients-health
        paths:
          - /api/v1/clients/health
        methods:
          - GET
        strip_path: false

  # ============================================================
  # PORTFOLIOS SERVICE (via Nginx LB)
  # ============================================================
  - name: portfolios-service
    url: http://nginx-lb:3002
    routes:
      - name: portfolios
        paths:
          - /api/v1/portfolios
        methods:
          - GET
          - POST
        strip_path: false
      
      - name: portfolios-by-id
        paths:
          - /api/v1/portfolios/
        methods:
          - GET
        strip_path: false
      
      - name: deposits
        paths:
          - /api/v1/deposits
        methods:
          - GET
          - POST
        strip_path: false
      
      - name: deposits-by-id
        paths:
          - /api/v1/deposits/
        methods:
          - GET
        strip_path: false
      
      - name: withdrawals
        paths:
          - /api/v1/withdrawals
        methods:
          - GET
          - POST
        strip_path: false
      
      - name: withdrawals-by-id
        paths:
          - /api/v1/withdrawals/
        methods:
          - GET
        strip_path: false
      
      - name: portfolios-health
        paths:
          - /api/v1/portfolios/health
        methods:
          - GET
        strip_path: false

  # ============================================================
  # ORDERS SERVICE (via Nginx LB)
  # ============================================================
  - name: orders-service
    url: http://nginx-lb:3003
    routes:
      - name: orders
        paths:
          - /api/v1/orders
        methods:
          - GET
          - POST
        strip_path: false
      
      - name: orders-by-id
        paths:
          - /api/v1/orders/
        methods:
          - GET
          - POST
          - DELETE
        strip_path: false
      
      - name: trades
        paths:
          - /api/v1/trades
        methods:
          - GET
        strip_path: false
      
      - name: market-data
        paths:
          - /api/v1/market_data
        methods:
          - GET
        strip_path: false
      
      - name: orders-health
        paths:
          - /api/v1/orders/health
        methods:
          - GET
        strip_path: false

  # ============================================================
  # WEBSOCKET (ActionCable via Nginx LB)
  # ============================================================
  - name: websocket-service
    url: http://nginx-lb:3003
    routes:
      - name: cable
        paths:
          - /cable
        strip_path: false

  # ============================================================
  # LOAD BALANCER STATUS
  # ============================================================
  - name: nginx-status
    url: http://nginx-lb:8081
    routes:
      - name: lb-status
        paths:
          - /lb/status
        methods:
          - GET
        strip_path: true
      
      - name: lb-health
        paths:
          - /lb/health
        methods:
          - GET
        strip_path: true

# ============================================================
# PLUGINS
# ============================================================
plugins:
  # Rate Limiting global
  - name: rate-limiting
    config:
      minute: 100
      policy: local
  
  # CORS
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
        - Accept
        - Idempotency-Key
        - X-Idempotency-Key
      exposed_headers:
        - X-Instance-Id
        - X-Upstream-Server
      credentials: true
      max_age: 3600
  
  # Request ID for tracing
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true
