# Kong Gateway Configuration - BrokerX Microservices (Local Mode)
# Routes traffic to services running on host machine

_format_version: "3.0"
_transform: true

services:
  # ============================================================
  # CLIENTS SERVICE (UC-01, UC-02)
  # ============================================================
  - name: clients-service
    url: http://host.docker.internal:3001
    routes:
      - name: clients-register
        paths:
          - /api/v1/clients
        methods:
          - POST
          - GET
        strip_path: false
      
      - name: clients-verify
        paths:
          - /api/v1/clients/verify
        methods:
          - GET
        strip_path: false
      
      - name: auth-login
        paths:
          - /api/v1/auth/login
        methods:
          - POST
        strip_path: false
      
      - name: auth-mfa
        paths:
          - /api/v1/auth/verify_mfa
        methods:
          - POST
        strip_path: false
      
      - name: clients-health
        paths:
          - /clients/health
        methods:
          - GET
        strip_path: true

  # ============================================================
  # PORTFOLIOS SERVICE (UC-03)
  # ============================================================
  - name: portfolios-service
    url: http://host.docker.internal:3002
    routes:
      - name: portfolios
        paths:
          - /api/v1/portfolios
        methods:
          - GET
          - POST
        strip_path: false
      
      - name: portfolios-by-id
        paths:
          - /api/v1/portfolios/
        methods:
          - GET
        strip_path: false
      
      - name: deposits
        paths:
          - /api/v1/deposits
        methods:
          - GET
          - POST
        strip_path: false
      
      - name: deposits-by-id
        paths:
          - /api/v1/deposits/
        methods:
          - GET
        strip_path: false
      
      - name: withdrawals
        paths:
          - /api/v1/withdrawals
        methods:
          - GET
          - POST
        strip_path: false
      
      - name: withdrawals-by-id
        paths:
          - /api/v1/withdrawals/
        methods:
          - GET
        strip_path: false

      - name: portfolios-health
        paths:
          - /portfolios/health
        methods:
          - GET
        strip_path: true

  # ============================================================
  # ORDERS SERVICE (UC-04, UC-05, UC-06, UC-07, UC-08)
  # ============================================================
  - name: orders-service
    url: http://host.docker.internal:3003
    routes:
      - name: orders
        paths:
          - /api/v1/orders
        methods:
          - GET
          - POST
        strip_path: false
      
      - name: orders-by-id
        paths:
          - /api/v1/orders/
        methods:
          - GET
          - POST
          - DELETE
        strip_path: false

      - name: orders-health
        paths:
          - /orders/health
        methods:
          - GET
        strip_path: true

  # ============================================================
  # WEBSOCKET (ActionCable)
  # ============================================================
  - name: websocket-service
    url: http://host.docker.internal:3003
    routes:
      - name: cable
        paths:
          - /cable
        strip_path: false

  # ============================================================
  # METRICS (for Prometheus)
  # ============================================================
  - name: clients-metrics
    url: http://host.docker.internal:3001
    routes:
      - name: clients-metrics-route
        paths:
          - /clients/metrics
        methods:
          - GET
        strip_path: true

  - name: portfolios-metrics
    url: http://host.docker.internal:3002
    routes:
      - name: portfolios-metrics-route
        paths:
          - /portfolios/metrics
        methods:
          - GET
        strip_path: true

  - name: orders-metrics
    url: http://host.docker.internal:3003
    routes:
      - name: orders-metrics-route
        paths:
          - /orders/metrics
        methods:
          - GET
        strip_path: true

# ============================================================
# PLUGINS
# ============================================================
plugins:
  # Rate Limiting global
  - name: rate-limiting
    config:
      minute: 100
      policy: local
  
  # CORS
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
        - Accept
        - Idempotency-Key
      exposed_headers:
        - X-Instance-Id
      credentials: true
      max_age: 3600

  # Prometheus metrics
  - name: prometheus
    config:
      per_consumer: false
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true
