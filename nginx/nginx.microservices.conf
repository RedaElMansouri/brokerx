# nginx/nginx.microservices.conf
# ============================================================
# BrokerX - Nginx Load Balancer for Microservices
# ============================================================
# Chaque microservice a plusieurs instances avec load balancing
# Kong reste l'API Gateway, Nginx fait le LB interne
# ============================================================

# ============================================================
# UPSTREAMS - Load Balancing Configuration
# ============================================================

# Clients Service - 2 instances
upstream clients_service {
    least_conn;
    server clients-service-1:3000 weight=1;
    server clients-service-2:3000 weight=1;
    keepalive 16;
}

# Portfolios Service - 2 instances
upstream portfolios_service {
    least_conn;
    server portfolios-service-1:3000 weight=1;
    server portfolios-service-2:3000 weight=1;
    keepalive 16;
}

# Orders Service - 3 instances (plus de charge)
upstream orders_service {
    least_conn;
    server orders-service-1:3000 weight=1;
    server orders-service-2:3000 weight=1;
    server orders-service-3:3000 weight=1;
    keepalive 32;
}

# ============================================================
# CLIENTS SERVICE LOAD BALANCER
# ============================================================
server {
    listen 3001;
    server_name localhost;

    access_log /var/log/nginx/clients_access.log;
    error_log /var/log/nginx/clients_error.log;

    location / {
        proxy_pass http://clients_service;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Instance ID header for debugging
        add_header X-Upstream-Server $upstream_addr always;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    location /health {
        proxy_pass http://clients_service/health;
        proxy_set_header Host $host;
    }
}

# ============================================================
# PORTFOLIOS SERVICE LOAD BALANCER
# ============================================================
server {
    listen 3002;
    server_name localhost;

    access_log /var/log/nginx/portfolios_access.log;
    error_log /var/log/nginx/portfolios_error.log;

    location / {
        proxy_pass http://portfolios_service;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header X-Upstream-Server $upstream_addr always;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    location /health {
        proxy_pass http://portfolios_service/health;
        proxy_set_header Host $host;
    }
}

# ============================================================
# ORDERS SERVICE LOAD BALANCER
# ============================================================
server {
    listen 3003;
    server_name localhost;

    access_log /var/log/nginx/orders_access.log;
    error_log /var/log/nginx/orders_error.log;

    location / {
        proxy_pass http://orders_service;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header X-Upstream-Server $upstream_addr always;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # WebSocket support pour ActionCable
    location /cable {
        proxy_pass http://orders_service;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Long timeout for WebSocket
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    location /health {
        proxy_pass http://orders_service/health;
        proxy_set_header Host $host;
    }
}

# ============================================================
# NGINX STATUS & HEALTH
# ============================================================
server {
    listen 8081;
    server_name localhost;

    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    location /nginx-status {
        stub_status on;
        access_log off;
    }
}
